<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Hero</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7' },
                        duo: {
                            orange: '#ff9600',
                            red: '#ff4b4b',
                            green: '#58cc02',
                            green_dark: '#46a302'
                        },
                        dark: { bg: '#0f172a', card: '#1e293b' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .loading-dots:after {
            content: '.'; animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; }
        }
        .quote-progress-bar { width: 0%; height: 100%; background-color: #0ea5e9; }
        .quote-progress-bar.animate { transition: width 30s linear; width: 100%; }
        .streak-fire { filter: drop-shadow(0 0 5px rgba(255, 150, 0, 0.5)); }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <!-- Header Section -->
    <header class="p-4 md:p-8 max-w-6xl mx-auto w-full">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-brand-400 to-purple-400 self-start md:self-center">
                <i class="fa-solid fa-mountain-sun mr-2 text-brand-500"></i>Habit Hero
            </h1>
            
            <!-- Global Settings -->
            <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-xl self-end md:self-center">
                <div class="relative">
                    <select id="globalLanguage" onchange="updateGlobalLanguage()" class="bg-slate-900 border border-slate-700 text-xs rounded-lg px-3 py-2 text-white focus:outline-none focus:border-brand-500 appearance-none cursor-pointer pr-8 w-32 md:w-40">
                        <!-- Languages injected via JS -->
                    </select>
                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none">
                        <i class="fa-solid fa-earth-americas text-xs"></i>
                    </div>
                </div>
                <button onclick="toggleModal('settingsModal')" class="text-slate-400 hover:text-white transition px-2">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Quote Card -->
        <div class="glass-panel p-6 rounded-2xl shadow-lg relative overflow-hidden group transition-all duration-500 min-h-[140px] flex flex-col justify-center">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <i class="fa-solid fa-quote-right text-6xl"></i>
            </div>
            <!-- Synchronized Progress bar -->
            <div class="absolute top-0 left-0 h-1 bg-brand-500/30 w-full">
                <div id="quoteProgress" class="quote-progress-bar"></div>
            </div>
            
            <div id="quoteContainer" class="relative z-10 flex flex-col justify-center h-full">
                <p id="quoteText" class="text-xl md:text-2xl font-light italic mb-3 text-slate-100 transition-opacity duration-500">"Loading inspiration..."</p>
                <p id="quoteAuthor" class="text-sm font-semibold text-brand-400 tracking-wide uppercase transition-opacity duration-500">â€” ...</p>
            </div>
            
            <!-- Quote Controls -->
            <div class="absolute bottom-2 right-4 flex gap-2">
                <button onclick="forceRefreshQuote()" class="text-[10px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded transition">
                    <i class="fa-solid fa-forward"></i> Next
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 md:px-8 max-w-6xl mx-auto w-full pb-20">
        
        <!-- Action Bar -->
        <div class="flex justify-between items-end mb-6">
            <div>
                <h2 class="text-xl font-semibold text-white">Your Habits</h2>
                <p class="text-sm text-slate-400" id="habitCount">Loading habits...</p>
            </div>
            <button onclick="toggleModal('addHabitModal')" class="bg-brand-600 hover:bg-brand-500 text-white px-5 py-2.5 rounded-xl font-medium shadow-lg shadow-brand-500/20 transition flex items-center gap-2 transform hover:scale-105 active:scale-95">
                <i class="fa-solid fa-plus"></i> Add New
            </button>
        </div>

        <!-- Habits Grid -->
        <div id="habitsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Habits will be injected here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-center opacity-70">
            <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-3xl">ðŸŒ±</div>
            <h3 class="text-lg font-medium text-white">No habits yet</h3>
            <p class="text-slate-400 max-w-xs mx-auto mt-2">Start your journey by adding a habit you want to build today.</p>
        </div>

    </main>

    <!-- Add Habit Modal -->
    <div id="addHabitModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-dark-card border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl animate-fade-in overflow-hidden max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center sticky top-0 bg-dark-card z-10">
                <h3 class="text-lg font-bold">New Habit</h3>
                <button onclick="toggleModal('addHabitModal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Habit Name</label>
                    <input type="text" id="newHabitName" placeholder="e.g. Brush Teeth" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition">
                </div>
                
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Coach Language</label>
                    <div class="relative">
                        <select id="newHabitLanguage" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-brand-500 appearance-none cursor-pointer">
                            <!-- Injected via JS -->
                        </select>
                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 pointer-events-none">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">The AI Coach will respond in this language.</p>
                </div>

                <div>
                    <label class="block text-sm text-slate-400 mb-1">Icon</label>
                    <div class="grid grid-cols-6 gap-2" id="iconSelector">
                        <!-- Icons injected via JS -->
                    </div>
                </div>
            </div>
            <div class="p-6 pt-0 flex gap-3 sticky bottom-0 bg-dark-card">
                <button onclick="toggleModal('addHabitModal')" class="flex-1 py-3 rounded-xl font-medium text-slate-300 hover:bg-slate-800 transition">Cancel</button>
                <button onclick="addHabit()" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-3 rounded-xl font-medium shadow-lg shadow-brand-500/20 transition">Create Habit</button>
            </div>
        </div>
    </div>

    <!-- AI Helper Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-dark-card border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl animate-fade-in flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-slate-700 bg-gradient-to-r from-slate-800 to-slate-900 flex justify-between items-center rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center shadow-lg">
                        <i class="fa-solid fa-robot text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-white">Pollinations AI Coach</h3>
                        <p class="text-xs text-indigo-300">Fast & Free</p>
                    </div>
                </div>
                <button onclick="toggleModal('aiModal')" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow">
                <div id="aiContent" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-dark-card border border-slate-700 w-full max-w-md rounded-2xl shadow-2xl p-6">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <p class="text-slate-300 text-sm mb-4">
                Your habits are saved securely in your browser's <strong>LocalStorage</strong>.
            </p>
            <div class="bg-slate-800 rounded-lg p-3 mb-4 space-y-2">
                <h4 class="font-semibold text-sm text-white">Debug Data</h4>
                <p class="text-xs text-slate-400">Total Habits: <span id="debugTotal">0</span></p>
                <p class="text-xs text-slate-400">Detected Lang: <span id="debugLang" class="font-mono">...</span></p>
            </div>
            <button onclick="toggleModal('settingsModal')" class="w-full bg-slate-800 hover:bg-slate-700 py-2 rounded-lg transition">Close</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-600 flex items-center gap-3 transition-all duration-300 opacity-0 translate-y-10 z-[60]">
        <i class="fa-solid fa-check-circle text-green-400"></i>
        <span id="toastMsg">Action successful</span>
    </div>

    <script>
        // --- Constants & Config ---
        const ICONS = [
            'fa-person-running', 'fa-book-open', 'fa-glass-water', 'fa-bed', 
            'fa-dumbbell', 'fa-carrot', 'fa-guitar', 'fa-code', 
            'fa-tooth', 'fa-briefcase', 'fa-pen-nib', 'fa-bicycle',
            'fa-leaf', 'fa-brain', 'fa-music', 'fa-paintbrush',
            'fa-gamepad', 'fa-paw', 'fa-money-bill-wave', 'fa-heart-pulse'
        ];

        const LANGUAGES = [
            { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' }, { code: 'pl', name: 'Polish', flag: 'ðŸ‡µðŸ‡±' },
            { code: 'es', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' }, { code: 'fr', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'de', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' }, { code: 'it', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'pt', name: 'Portuguese', flag: 'ðŸ‡µðŸ‡¹' }, { code: 'nl', name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
            { code: 'ru', name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' }, { code: 'ja', name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'ko', name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' }, { code: 'zh', name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
            { code: 'hi', name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' }, { code: 'ar', name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
            { code: 'tr', name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' }
        ];
        
        // --- State ---
        let habits = [];
        let globalLang = 'en'; 
        let quoteBuffer = [];
        let quoteIntervalId;
        const QUOTE_INTERVAL = 30000; // 30 Seconds

        window.currentSelectedIcon = ICONS[0];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Detect or Load Language
            initLanguage();
            
            // 2. Load Data from LocalStorage
            loadHabits();
            
            // 3. Setup UI
            initializeLanguageSelectors();
            setupIcons();
            
            // 4. Start Quotes
            startQuoteEngine();
        });

        function initLanguage() {
            const savedLang = localStorage.getItem('habitHero_lang');
            
            if (savedLang) {
                globalLang = savedLang;
                document.getElementById('debugLang').innerText = `${savedLang} (Saved)`;
            } else {
                // Auto-detect from browser
                const browserLang = navigator.language || navigator.userLanguage; // e.g. "pl-PL"
                const code = browserLang.split('-')[0]; // "pl"
                
                // Check if we support it
                const isSupported = LANGUAGES.some(l => l.code === code);
                
                if (isSupported) {
                    globalLang = code;
                    localStorage.setItem('habitHero_lang', code); // Save detected pref
                    document.getElementById('debugLang').innerText = `${code} (Auto)`;
                } else {
                    globalLang = 'en';
                    document.getElementById('debugLang').innerText = `en (Default)`;
                }
            }
        }

        function loadHabits() {
            try {
                const stored = localStorage.getItem('habitHero_habits');
                if (stored) {
                    habits = JSON.parse(stored);
                } else {
                    habits = [];
                }
                updateHabitListUI();
            } catch (e) {
                console.error("Load error", e);
                habits = [];
            }
        }

        function saveHabits() {
            localStorage.setItem('habitHero_habits', JSON.stringify(habits));
            updateHabitListUI();
        }

        // --- Global Functions (Exposed) ---

        window.addHabit = function() {
            const name = document.getElementById('newHabitName').value.trim();
            const lang = document.getElementById('newHabitLanguage').value;
            const icon = window.currentSelectedIcon || 'fa-person-running';
            
            if (!name) return showToast('Please enter a habit name', true);

            const newHabit = {
                id: Date.now().toString(),
                name: name,
                icon: icon,
                startDate: new Date().toISOString().split('T')[0],
                language: lang,
                history: [],
                createdAt: Date.now()
            };

            habits.push(newHabit);
            saveHabits();
            
            toggleModal('addHabitModal');
            document.getElementById('newHabitName').value = '';
            showToast('Habit added locally!');
        };

        window.deleteHabit = function(id) {
            if(!confirm('Delete this habit?')) return;
            habits = habits.filter(h => h.id !== id);
            saveHabits();
            showToast('Habit deleted');
        };

        window.checkIn = function(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            const today = new Date().toISOString().split('T')[0];
            if (habit.history && habit.history.some(h => (h.date || h) === today)) return;

            const newEntry = {
                date: today,
                timestamp: Date.now()
            };

            habit.history.push(newEntry);
            saveHabits();
            
            showToast(`Checked in: ${habit.name}`);
        };

        // --- Language UI ---

        function initializeLanguageSelectors() {
            const options = LANGUAGES.map(l => `<option value="${l.code}">${l.flag} ${l.name}</option>`).join('');
            
            const globalSel = document.getElementById('globalLanguage');
            globalSel.innerHTML = options;
            globalSel.value = globalLang;

            const habitSel = document.getElementById('newHabitLanguage');
            habitSel.innerHTML = options;
            habitSel.value = globalLang;
        }

        window.updateGlobalLanguage = function() {
            globalLang = document.getElementById('globalLanguage').value;
            localStorage.setItem('habitHero_lang', globalLang);
            
            // Clear buffer and refresh quotes
            quoteBuffer = [];
            forceRefreshQuote();
        }

        // --- UI Rendering ---

        function updateHabitListUI() {
            const list = document.getElementById('habitsList');
            const count = document.getElementById('habitCount');
            const empty = document.getElementById('emptyState');
            const debugTotal = document.getElementById('debugTotal');
            
            count.innerText = `${habits.length} active habit${habits.length !== 1 ? 's' : ''}`;
            if(debugTotal) debugTotal.innerText = habits.length;

            if (habits.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                empty.classList.add('flex');
                return;
            }

            empty.classList.add('hidden');
            empty.classList.remove('flex');

            const today = new Date().toISOString().split('T')[0];

            list.innerHTML = habits.map(habit => {
                const history = habit.history || [];
                const doneToday = history.some(h => (h.date || h) === today);
                
                // Streak Calc
                const dates = [...new Set(history.map(h => h.date || h))].sort();
                let streak = 0;
                let checkDate = new Date();
                // If not done today, start checking from yesterday
                if (!doneToday) checkDate.setDate(checkDate.getDate() - 1);
                
                while(true) {
                    const str = checkDate.toISOString().split('T')[0];
                    if (dates.includes(str)) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                }

                // Styles
                let borderClass = doneToday ? 'border-duo-green' : (streak > 0 ? 'border-duo-orange' : 'border-slate-700');
                let fireClass = streak > 0 ? 'text-duo-orange streak-fire' : 'text-slate-600 grayscale';
                if (streak > 7) fireClass += ' animate-pulse-slow';
                
                const langName = LANGUAGES.find(l => l.code === (habit.language || 'en'))?.name || habit.language;

                return `
                <div class="glass-panel p-5 rounded-2xl transition group relative animate-fade-in border-l-4 ${borderClass}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center text-white text-xl shadow-inner relative">
                            <i class="fa-solid ${habit.icon}"></i>
                            ${doneToday ? '<div class="absolute -right-1 -top-1 bg-duo-green rounded-full w-4 h-4 border border-slate-900"></div>' : ''}
                        </div>
                        <div class="flex gap-2">
                             <button onclick="askAI('${habit.id}')" class="text-xs bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500/30 px-3 py-1.5 rounded-full transition font-semibold">
                                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Tips
                            </button>
                            <button onclick="deleteHabit('${habit.id}')" class="text-slate-600 hover:text-red-400 transition px-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-bold text-white mb-1 truncate">${habit.name}</h3>
                    <div class="flex items-center gap-2 mb-4 text-xs text-slate-500">
                         <span>${langName}</span> â€¢ <span>Streak: ${streak} days</span>
                    </div>
                    
                    <div class="bg-slate-900/60 rounded-xl p-3 flex items-center justify-between border border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-fire text-2xl ${fireClass} transition-colors duration-500"></i>
                            <div class="flex flex-col">
                                <span class="text-xl font-black ${streak > 0 ? 'text-white' : 'text-slate-500'} leading-none">${streak}</span>
                                <span class="text-[10px] uppercase font-bold tracking-wider text-slate-500">Streak</span>
                            </div>
                        </div>
                        
                        <button id="btn-${habit.id}" onclick="checkIn('${habit.id}')" ${doneToday ? 'disabled' : ''} class="px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-lg ${doneToday ? 'bg-duo-green text-white cursor-default' : 'bg-slate-700 hover:bg-duo-green_dark hover:text-white text-slate-300'}">
                            ${doneToday ? '<i class="fa-solid fa-check"></i> Done' : 'Check In'}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- Quote Engine ---
        
        function startQuoteEngine() {
            displayNextQuote(); 
            
            if (quoteIntervalId) clearInterval(quoteIntervalId);
            
            const bar = document.getElementById('quoteProgress');
            
            function loop() {
                bar.classList.remove('animate');
                void bar.offsetWidth; 
                bar.classList.add('animate');

                setTimeout(() => {
                    displayNextQuote();
                    loop(); 
                }, QUOTE_INTERVAL);
            }
            
            loop();
        }

        window.forceRefreshQuote = function() {
            if(quoteBuffer.length < 1) fetchQuotesBatch();
            displayNextQuote();
            const bar = document.getElementById('quoteProgress');
            bar.classList.remove('animate');
            void bar.offsetWidth;
            bar.classList.add('animate');
        }

        async function fetchQuotesBatch() {
            try {
                const response = await fetch('https://dummyjson.com/quotes?limit=5&skip=' + Math.floor(Math.random() * 100));
                const data = await response.json();
                data.quotes.forEach(q => {
                    quoteBuffer.push({ text: q.quote, author: q.author });
                });
            } catch (e) {
                quoteBuffer.push({ text: "Consistency is key.", author: "Habit Hero" });
            }
        }

        async function displayNextQuote() {
            if (quoteBuffer.length < 2) fetchQuotesBatch();
            if (quoteBuffer.length === 0) await fetchQuotesBatch();
            
            const rawQuote = quoteBuffer.shift() || { text: "Loading...", author: "" };
            
            const textEl = document.getElementById('quoteText');
            const authorEl = document.getElementById('quoteAuthor');
            
            textEl.style.opacity = '0';
            authorEl.style.opacity = '0';

            setTimeout(async () => {
                let finalText = rawQuote.text;
                let finalAuthor = rawQuote.author;

                if (globalLang !== 'en') {
                    try {
                        const pair = `en|${globalLang}`;
                        const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(rawQuote.text)}&langpair=${pair}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        
                        if (data.responseData && data.responseData.translatedText) {
                            finalText = data.responseData.translatedText;
                        }
                    } catch (e) {
                        console.warn("Translation failed");
                    }
                }

                textEl.innerText = `"${finalText}"`;
                authorEl.innerText = `â€” ${finalAuthor}`;
                textEl.style.opacity = '1';
                authorEl.style.opacity = '1';
            }, 500);
        }

        // --- AI Logic ---
        window.askAI = async function(habitId) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;

            const modal = document.getElementById('aiModal');
            const content = document.getElementById('aiContent');
            toggleModal('aiModal');
            
            const langName = LANGUAGES.find(l => l.code === (habit.language || 'en'))?.name || 'English';

            content.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="text-brand-500 text-4xl mb-4"><i class="fa-solid fa-brain fa-bounce"></i></div>
                    <p class="text-slate-300 font-medium">Consulting Coach...</p>
                    <p class="text-slate-500 text-sm mt-1">Language: ${langName}</p>
                    <p class="text-slate-500 text-sm mt-2 loading-dots">Thinking</p>
                </div>
            `;

            try {
                const prompt = `Act as a habit coach. Speak ONLY in ${langName}. Give 3 concise, specific tips to maintain the habit: "${habit.name}". Use HTML <li> tags. No intro text.`;
                const seed = Math.floor(Math.random() * 999999);
                const url = `https://text.pollinations.ai/${encodeURIComponent(prompt)}?model=openai&seed=${seed}`;
                
                const res = await fetch(url);
                if (res.status === 429) throw new Error("Rate limit");
                const text = await res.text();
                
                let formatted = text.replace(/```html/g, '').replace(/```/g, '');
                if (!formatted.includes('<li>')) {
                    formatted = `<ul class="list-disc pl-5 space-y-2"><li>${formatted}</li></ul>`;
                } else if (!formatted.includes('<ul>')) {
                    formatted = `<ul class="list-disc pl-5 space-y-2">${formatted}</ul>`;
                }

                content.innerHTML = `
                    <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-xl p-4 mb-4">
                        <h4 class="font-bold text-indigo-300 mb-2 border-b border-indigo-500/20 pb-2 flex justify-between">
                            <span>Advice: ${habit.name}</span>
                        </h4>
                        <div class="prose prose-invert prose-sm text-slate-300">
                            ${formatted}
                        </div>
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fa-solid fa-triangle-exclamation text-amber-500 text-3xl mb-3"></i>
                        <p class="text-slate-300">Coach is busy (Rate Limit).</p>
                        <p class="text-xs text-slate-500 mt-2">Try again in a minute.</p>
                    </div>
                `;
            }
        }

        // --- Utils ---
        function setupIcons() {
            const container = document.getElementById('iconSelector');
            container.innerHTML = ICONS.map(icon => `
                <button onclick="selectIcon('${icon}')" class="icon-btn w-8 h-8 md:w-10 md:h-10 rounded-lg bg-slate-800 hover:bg-slate-700 flex items-center justify-center transition ${icon === window.currentSelectedIcon ? 'ring-2 ring-brand-500 text-brand-500' : 'text-slate-400'}">
                    <i class="fa-solid ${icon}"></i>
                </button>
            `).join('');
        }

        window.selectIcon = function(icon) {
            window.currentSelectedIcon = icon;
            setupIcons(); 
        }

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        window.showToast = (msg, isError) => {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            toast.querySelector('i').className = isError ? 'fa-solid fa-circle-exclamation text-red-400' : 'fa-solid fa-check-circle text-green-400';
            toast.classList.remove('translate-y-10', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-10', 'opacity-0'), 3000);
        }

    </script>
</body>
</html>
